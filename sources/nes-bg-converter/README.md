# NES BG Converter

ファミコン / NES 向け背景画像変換ツール (魔改造対応)

## 概要

任意の画像をファミコンのハードウェア制約に合わせた形式に変換する。標準のNES仕様に加え、拡張仕様 (魔改造モード) にも対応している。

## 対応仕様

### NES 標準仕様

- 解像度: 256 x 240
- パレット: 4本 x 4色 (共通背景色 + 3色)
- CHR (キャラクタ) 定義: 最大256個
- 属性ブロック: 16 x 16 ピクセル単位でパレット指定

### 魔改造仕様

- パレット: 最大32本 x 16色
- CHR定義: 最大2048個
- 出力解像度: QVGA (320 x 240), QVGA 2倍 (640 x 480) 対応

## 機能

### 出力設定

| 項目 | 選択肢 |
|---|---|
| 出力サイズモード | NES標準 (256x240), QVGA (320x240), QVGA 2倍 (640x480), オート |
| トリミング位置 | 25% - 75% (上下または左右) |
| ディザリング | なし, 市松模様, Bayer 2x2, Bayer 4x4 |

### パレット設定

| 項目 | 範囲 | 標準値 |
|---|---|---|
| パレット本数 | 4 - 32 | 4 |
| パレット内色数 | 4 - 16 | 4 |

### CHR設定

| 項目 | 範囲 | 標準値 |
|---|---|---|
| CHR定義数上限 | 128 - 2048 | 256 |
| タイル類似度閾値 | 0 - 50 | 15 |

類似度閾値を上げると、似たタイルが統合されCHR使用数が減るが、画質は低下する。

### 色調整

| 項目 | 範囲 |
|---|---|
| 明度 | -100 - +100 |
| コントラスト | -100 - +100 |
| 彩度 | -100 - +100 |

## カラーパレット

NES NTSC 54色パレットを使用。画像の色は自動的に最も近いNES色にマッピングされる。

## 処理フロー

1. 画像読み込みとトリミング
2. 色調整 (明度, コントラスト, 彩度)
3. 共通背景色の決定 (最頻出色)
4. 属性ブロック単位でのパレット生成 (k-means法)
5. 各属性ブロックへのパレット割り当て
6. ディザリングと減色
7. CHRタイル抽出と類似タイル統合
8. 出力画像とCHR定義画像の生成

## 出力

### 出力画像

変換後の画像。NESの制約内で元画像を再現したもの。

### CHR定義画像

使用されるすべてのタイルパターンを並べた画像。16タイル/行で配置。

## 使い方

1. 画像をドラッグアンドドロップまたはファイル選択で読み込む
2. 必要に応じて設定を調整
3. 「変換実行」ボタンをクリック
4. 出力画像を確認し、「保存」または「コピー」でエクスポート

## 設定の保存

「設定保存」ボタンでブラウザのCookieに設定を保存できる。次回アクセス時に自動的に復元される。

## 技術詳細

- パレット生成にk-means法を使用し、属性ブロック内の色分布を最適化
- タイル統合は色差の総和で類似度を判定
- Bayerディザリングは2x2および4x4マトリクスに対応
