# MSX Screen 2 Converter

MSX1 GRAPHIC 2 モード (Screen 2) 向け画像変換ツール

## 概要

任意の画像を MSX1 の Screen 2 (GRAPHIC 2) モードのハードウェア制約に合わせて変換する。8x1 ピクセルラインごとに2色までという厳しい制限の中で、可能な限り高品質な変換を行う。

## 対応仕様

### TMS9918 仕様

- 解像度: 256 x 192
- パレット: 15色固定 (TMS9918 パレット)
- 色制約: 8 x 1 ピクセルラインごとに2色まで
- パターン: 768個 (画面全体を個別定義可能)

### 拡張出力

- QVGA (320 x 240)
- QVGA 2倍 (640 x 480)
- オート (アスペクト比維持)

## TMS9918 パレット

| Index | 色名 | RGB |
|---|---|---|
| 1 | 黒 | (0, 0, 0) |
| 2 | 中緑 | (62, 184, 73) |
| 3 | 薄緑 | (116, 208, 125) |
| 4 | 暗青 | (89, 85, 224) |
| 5 | 薄青 | (128, 118, 241) |
| 6 | 暗赤 | (185, 94, 81) |
| 7 | シアン | (101, 219, 239) |
| 8 | 中赤 | (219, 101, 89) |
| 9 | 薄赤 | (255, 137, 125) |
| 10 | 暗黄 | (204, 195, 94) |
| 11 | 薄黄 | (222, 208, 135) |
| 12 | 暗緑 | (58, 162, 65) |
| 13 | マゼンタ | (183, 102, 181) |
| 14 | 灰 | (204, 204, 204) |
| 15 | 白 | (255, 255, 255) |

## 機能

### 基本設定

| 項目 | 選択肢 |
|---|---|
| 出力サイズモード | MSX標準 (256x192), QVGA, QVGA 2倍, オート |
| トリミング位置 | 25% - 75% |
| ディザリング | なし, 市松模様, 縦縞, 縦縞 (強), Bayer 2x2, Bayer 4x4 |

縦縞ディザは MSX の 8x1 ライン制約と相性が良く、横方向の色変化に強い。

### 輪郭強調 (達人モード)

Sobel エッジ検出を使用してオブジェクトの輪郭を際立たせる。

| 項目 | 説明 |
|---|---|
| エッジ検出感度 | 10 - 100 (低いほど多くのエッジを検出) |
| 輪郭色モード | 黒 (くっきり), 同系暗色 (自然), 自動 (コントラスト重視) |
| 輪郭優先度 | 色彩重視 - 輪郭重視のバランス調整 |

### 輝度ソート

奇数ラインを明るく、偶数ラインを暗くすることで横縞グラデーションを滑らかにする。

| モード | 説明 |
|---|---|
| 標準 | すべてのラインに適用 |
| 緩和 | 輝度差が大きい場合のみ適用 |

### 色相考慮 (肌色改善)

RGB 距離だけでなく色相 (Hue) も考慮して色を選択する。肌色が黄色っぽくなる問題を改善できる。

### 色調整

| 項目 | 範囲 |
|---|---|
| 明度 | -100 - +100 |
| コントラスト | -100 - +100 |
| 彩度 | -100 - +100 |

## 処理フロー

1. 画像読み込みとトリミング
2. 8ピクセル単位にアライメント
3. 色調整 (明度, コントラスト, 彩度)
4. エッジ検出 (輪郭強調有効時)
5. 8x1 ピクセルラインごとに最適な2色ペアを選択
6. 輝度ソート適用 (有効時)
7. ディザリングと減色
8. 出力画像生成

## 出力

### PNG 出力

変換後の画像を PNG 形式で保存またはクリップボードにコピー。

### .scr ファイル出力

MSX 標準モード (256x192) でのみ、BLOAD 形式の .scr ファイルを出力可能。

構造:
- パターンデータ: 6144 bytes
- カラーデータ: 6144 bytes

## 使い方

1. 画像をドラッグアンドドロップまたはファイル選択で読み込む
2. 出力モードとディザリング方式を選択
3. 必要に応じて達人モード (輪郭強調, 輝度ソート, 色相考慮) を有効化
4. 「変換実行」ボタンをクリック
5. 結果を確認し、PNG または .scr 形式で保存

## 既知の問題

- .scr ファイル出力は実機で正しく読み込めない場合がある (フォーマット修正予定)

## 技術詳細

- 8x1 ライン内の全ピクセルに対して、15色から最適な2色ペアを全探索
- 色相考慮時は HSL 色空間での色相距離も加味
- Sobel フィルタによるエッジ検出でオブジェクト境界を識別
