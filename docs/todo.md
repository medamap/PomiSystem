# ToDo

## Rule

- このファイルは「大分類 / 中分類 / 小分類」の3層でタスクを管理する。
- 大分類・中分類には必ず外部キーを付与する。
- 外部キーは「YYYY/MM/DD HH:mm Z0001」形式（同時生成が被る場合はZ番号をインクリメント）。
- 中分類・小分類は外部キーで紐づくものとして運用する。
- 作業が枝分かれした場合は随時ここに追記する。
- 「作業プラン提示→許可取得→実行」の短期タスク（ローカルスコープ）は登録不要。

## 大分類

- [x] リファクタリング (2026/01/31 15:39 Z0001)
- [ ] X1移植 (2026/02/01 11:50 Z0001)
  - [ ] X1入力プレビューのズームでキャンバス再生成 (2026/02/02 10:45 Z0001)
    - [ ] 入力プレビューズーム変更時に再描画フック追加
    - [ ] 再描画時にキャンバスサイズを再計算
    - [ ] ズーム変更が完了した時点でプレビュー反映
  - [ ] X1自動更新トグルの追加 (2026/02/02 10:46 Z0001)
    - [ ] 自動更新ON/OFFのUI
    - [ ] OFF時は手動変換のみ反映
    - [ ] ON時は値変更完了で変換
  - [ ] X1旧機能の移植（画質調整/PCG/制約/減色）(2026/02/02 10:47 Z0001)
    - [ ] 画質調整（明るさ/コントラスト/彩度）をX1でも適用
    - [x] 色相重視・重みパラメータの再導入
    - [ ] PCG生成（8x8タイル）と出力形式
    - [ ] タイルリデュース（類似度統合/閾値）とエッジ保護
    - [ ] 無制限PCGモード/制限モードの切替
  - [ ] 機種切替の動的ロード設計 (2026/02/02 10:48 Z0001)
    - [ ] ターゲット選択時に必要なJSのみロード
    - [ ] 未ロード時のReady判定とUI待機表示
    - [ ] ロード失敗時のユーザー向けエラー表示
  - [ ] ターゲット追加時の枝葉修正ゼロ化（設定駆動化）(2026/02/02 22:20 Z0001)
    - [ ] ターゲット一覧/説明/既定値を1か所で定義
    - [ ] UI分岐の共通化（SelectedTarget == "x" 直書きを排除）
    - [ ] 変換パイプラインの登録制（ターゲットごとの関数群登録）
- [ ] DDD向け大規模改修（X1対応後に着手）(2026/02/02 11:20 Z0001)
- [ ] C++ネイティブ移植（WASMとは別路線）(2026/02/02 11:30 Z0001)

## 中分類

- [x] リファクタリング (2026/01/31 15:39 Z0001)
  - [ ] 共通処理の分離（msx-main内の共通ユーティリティ）(2026/02/02 11:10 Z0001)
  - [ ] 画面レイアウト改善（使いやすさ向上）(2026/02/02 11:12 Z0001)
    - [ ] PCレイアウトの再設計
    - [ ] タブレット（iPad）向け調整
    - [ ] スマホ向け調整
    - [ ] 全幅モード追加（UIトグル）(2026/02/02 12:05 Z0001)
      - [x] 標準/全幅の切替UI
      - [x] レイアウト切替CSS（コンテナ幅/余白/パネル幅）
      - [x] 状態の保存（次回起動時に復元）
      - [x] 既定値の決定（標準/全幅）
    - [ ] プレビュー表示モード切替（ピクセル/スムーズ）(2026/02/02 12:10 Z0001)
      - [x] 入力キャンバス表示モード切替トグル
      - [x] 出力キャンバス表示モード切替トグル
      - [ ] image-rendering / imageSmoothingEnabled の反映
    - [ ] スライダーUIのレイアウト固定（文字変化で改行しない）(2026/02/02 12:40 Z0001)
      - [ ] スライダー1行の幅を固定（値表示が変化しても改行しない）
      - [ ] MSX/X1/将来機種で共通コンポーネント化
    - [ ] X1ドット比率表示モード（1:1 / 1:2）(2026/02/02 12:20 Z0001)
      - [ ] ドット比率の選択UI（320x200=1:1 / 640x200=1:2）
      - [ ] 変換データは1:1保持、表示のみアスペクト補正
      - [ ] プレビュー表示の横方向スケール補正
      - [ ] 保存PNGへの適用有無（表示のみか出力にも反映か）
    - [ ] PNG出力の画質調整パネル (2026/02/02 12:21 Z0001)
      - [ ] バイリニアフィルタON/OFF
      - [ ] ドット比率適用ON/OFF
      - [ ] ドット比率適用方式（横2ピクセル結合/間引きの切替）
- [ ] DDD向け大規模改修（X1対応後に着手）(2026/02/02 11:20 Z0001)
  - [ ] CLIターゲット先行（最小変換）(2026/02/02 11:21 Z0001)
- [ ] 高速/低速二重実装方針（JS/オールWASM）(2026/02/02 10:20 Z0002)
  - [ ] 高速モード（JS/Canvas）を既定とする
  - [ ] 低速モード（オールWASM/C#）を保持
  - [ ] モード切替のUI/設定（環境依存も含む）
  - [ ] 出力差分テスト（画像/ハッシュ/許容誤差の定義）
  - [ ] 仕様の正（参照）をC#実装に置く
- [ ] C++ネイティブ移植（WASMとは別路線）(2026/02/02 11:30 Z0001)
  - [ ] CLI最小変換（Windows/Mac/Linux）(2026/02/02 11:31 Z0001)
  - [ ] Android/iOS へのネイティブ展開方針
  - [ ] Raspberry Piベアメタル/組込み向けの実行方針
  - [x] 小さく切り出して共通化（縮小/減色から）
  - [x] フォールバック縮小と共通API依存の明確化 (2026/01/31 17:14 Z0001)
  - [x] 入力ガード追加（pomi-image）
  - [x] MSX固有出力の分離（SC2 exporter）
  - [x] ユーザー向けエラー表示（必須モジュール未ロード時）
  - [x] pomi-storage の名称見直し（MSX controller系）

## 小分類

- [x] フォールバック縮小と共通API依存の明確化 (2026/01/31 17:14 Z0001)
  - [x] pomi-storage のフォールバック関数削減
  - [x] ロード失敗時の明示エラー出力
  - [x] startIndex の一貫性整理
  - [x] SC2 exporter を ImageData 入力の純関数に整理

- [x] 小さく切り出して共通化（縮小/減色から） (2026/02/01 10:20 Z0001)
  - [x] 画像リサイズ/クロップの共通I/O定義（入力と戻り値の型を統一）
    - [x] I/O案: input { canvas, dataUrl, outputMode, cropPosition, smooth, fillStyle }
    - [x] I/O案: output { img, srcW, srcH, targetW, targetH, dims, ctx }
    - [x] dims案: { width, height, cropX, cropY, srcW, srcH, cropDirection, cropPosition }
    - [x] 共通スキーマ名（候補）: ResizeRequest / ResizeResult / ResizeDims
  - [x] 色調整（brightness/contrast/saturation）を共通処理として切り出し済み範囲の点検
    - [x] パラメータの基準値（0=無変更）と範囲をUI/実装で一致させる
    - [x] 画像調整は in-place 変更であることを共通仕様として明記
  - [x] パレット処理（nearest/chooseLineColors）の共通API整合性確認
    - [x] パレット取得/デフォルト取得のI/F固定（getPalette/getDefaults/registerPalette）
    - [x] 距離計算/nearest の引数順序と startIndex 既定値の統一
    - [x] chooseLineColors の責務（8px/行/2色）をMSX固有として明記
  - [x] ディザ処理（ordered/error/stripe bias）の共通化境界を整理
    - [x] ディザの責務を分割（しきい値生成 / 誤差分散 / バイアス計算）
    - [x] 入力パラメータの標準化（mode/strength/coords/targetW/H）
    - [x] エラー拡散のワークバッファI/O（workR/G/B）を共通化前提で整理
    - [x] MSX固有の「2色選択」はディザ外部に残す方針を明記
  - [x] MSX/X1 の drawPreview を共通パイプラインに寄せる方針検討
    - [x] 共通フロー案: Resize → (Adjust optional) → (Palette/Dither optional)
    - [x] MSX preview は Adjust/Palette/Dither を省略、X1 preview も同様に省略
    - [x] 将来のX1実装で Adjust を有効化するかの判断基準を整理
      - [x] 判断基準: 出力が「実機に近い見た目」を優先する場合はAdjustを有効化
      - [x] 判断基準: 入力画像の色味を尊重する場合はAdjustを無効のまま
      - [x] 判断基準: 変換品質の比較検証が必要ならUIで切替可能にする
